<% if (username_signed_in?) %>
  <% idreg1 = current_username.id %>
<% end %>
<% topicid = @topic.id %>
<% datatest = @topic.consents.find_by(userid: idreg1).created_at %>
<% counttrue = Consent.find_by(userid: idreg1, topic_id: topicid).counttrue %>
<div class="container-fluid">
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Дата тестирования:</h4>
    </div>
    <div class="col-6 tbl-answer">
      <h4><%= datatest.strftime("%d.%m.%Y") %></h4>
    </div>
  </div>
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Количество вопросов:</h4>
    </div>
    <div class="col-6 tbl-answer">
      <h4><%= @topic.countquestions%></h4>
    </div>
  </div>
  <% if counttrue == nil%>
    <% counttrue = 0 %>
  <% end %>
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Правильных ответов:</h4>
    </div>
    <div class="col-6 tbl-answer">
      <h4><%= counttrue %></h4>
    </div>
  </div>
  <% lastanswer = Answer.where(userid: idreg1, topic_id: topicid).last %>
  <% firstanswer = Consent.find_by(userid: idreg1, topic_id: topicid).created_at %>
  <% totaltimesec = lastanswer.created_at.to_i - firstanswer.to_i %>
  <% totaltime = Consent.find_by(userid: idreg1, topic_id: topicid) %>
  <% if Consent.find_by(userid: idreg1, topic_id: topicid).questionsall == @topic.countquestions %>
    <% createdconsent = Consent.find_by(userid: idreg1, topic_id: topicid).created_at %>
    <% createdanswer = Answer.where(userid: idreg1, topic_id: topicid).last.created_at %>
    <% tansweruser = createdanswer - createdconsent %>
    <% totaltime.update(totaltime: tansweruser) %>
  <% else %>
    <% totaltime.update(totaltime: ttaskall) %>
  <% end %>
  <% ttimeconsent = Consent.find_by(userid: idreg1, topic_id: topicid).totaltime %>
  <% if ttimeconsent %>
    <% if ttimeconsent > 3599 %>
      <% tth = ttimeconsent / 3600 %>
      <% ttm = (ttimeconsent - tth * 3600) / 60 %>
      <% tts = ttimeconsent - (tth * 3600 + ttm * 60) %>
    <% end %>
    <% if ttimeconsent < 3600 and ttimeconsent > 59 %>
        <% tth = 0 %>
        <% ttm = ttimeconsent / 60 %>
        <% tts = ttimeconsent - (ttm * 60) %>
    <% end %>
    <% if ttimeconsent < 60 and ttimeconsent > 0 %>
      <% tth = 0 %>
      <% ttm = 0 %>
      <% tts = ttimeconsent %>
    <% end %>
  <% end %>
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Время прохождения теста:</h4>
  </div>
    <div class="col-6 tbl-answer">
      <h4>
        <% if ttimeconsent %>
          <% if tth > 0 %>
            <%= tth %> ч.
          <% end %>
          <% if ttm > 0 %>
            <%= ttm %> мин
          <% end %>
          <%= tts %> сек.
        <% end %>
      </h4>
    </div>
  </div>
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Количество участников:</h4>
    </div>
    <div class="col-6 tbl-answer">
      <h4><%= Consent.where(topic_id: topicid).count %> </h4>
    </div>
  </div>
  <% counttrueconsent = Consent.where(topic_id: topicid) %>
  <% counttruemax = counttrueconsent.maximum("counttrue") %>
  <% totalt = Consent.where(topic_id: topicid, counttrue: counttruemax) %>
  <% totaltmin = totalt.minimum("totaltime") %>
  <% if totaltmin > 3599 %>
    <% th = ttimeconsent / 3600 %>
    <% tm = (ttimeconsent - tth * 3600) / 60 %>
    <% ts = ttimeconsent - (tth * 3600 + ttm * 60) %>
  <% end %>
  <% if totaltmin < 3600 and totaltmin > 59 %>
    <% th = 0 %>
    <% tm = ttimeconsent / 60 %>
    <% ts = ttimeconsent - (tm * 60) %>
  <% end %>
  <% if totaltmin < 60 and totaltmin > 0 %>
    <% th = 0 %>
    <% tm = 0 %>
    <% ts = ttimeconsent %>
  <% end %>
  <div class="row">
    <div class="col-6 tbl-answer">
      <h4>Лучший результат:</h4>
    </div>
    <div class="col-6 tbl-answer">
      <h4>
        <% if counttruemax > 0 %>
          <% if counttruemax == 1 or counttruemax == 21 or counttruemax == 31 or counttruemax == 41 or counttruemax == 51 or counttruemax == 61 or counttruemax == 71 or counttruemax == 81 or counttruemax == 91 %>
            <%= counttruemax %> правильный ответ (<% if th > 0 %> <%= th %> ч. <% end %><% if tm > 0 %><%= tm %> мин. <% end %><%= ts %> сек.)
          <% else %>
            <%= counttruemax %> правильных ответов (<% if th > 0 %> <%= th %> ч. <% end %><% if tm > 0 %><%= tm %> мин. <% end %><%= ts %> сек.)
          <% end %>
        <% end %>
      </h4>
    </div>
  </div>
<% position = 1 %>
<% @topic.consents.each do |topcon| %>
  <% if counttrue < topcon.counttrue %>
  <% position += 1 %>
<% end %>
<% if counttrue == topcon.counttrue and totaltime.totaltime > topcon.totaltime %>
    <% position += 1 %>
<% end %>
<% end %>
<div class="row">
  <div class="col-6 tbl-answer">
    <h4>Ваше место:</h4>
  </div>
    <div class="col-6 tbl-answer">
  <h4># <%= position %></h4>
  </div>
</div>
  <div class="row">
    <div class="col-12 tbl-answer">
      <% if @topic.sucquest > Consent.find_by(userid: idreg1, topic_id: topicid).counttrue %>
        <h4><%= @topic.failuremessage %></h4>
      <% else %>
          <h4><%= @topic.successmessage %></h4>
      <% end %>
    </div>
  </div>
</div>
