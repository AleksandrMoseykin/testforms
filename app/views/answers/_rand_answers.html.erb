<!-- Узнаем id пользователя и  id задания-->
<% if (username_signed_in?) %>
  <% idreg1 = current_username.id %>
<% end %>
<% topicid = @topic.id %>
<% $username_id = current_username.id %>
<!-- Выводим таймер -->
<%= render "answers/timer" %>

<!-- Узнаем количество вопросов в задании -->
<% count_questions_topic = @topic.questions.count %>

<!-- Создаем переменную с количеством вопросов -->
<% questionsall = Answer.where(userid: idreg1, topic_id: topicid).count %>

<!-- Если количество вопросов равно количеству ответов -->
<% if count_questions_topic == questionsall %>

<% reserv = Answer.find_by(userid: idreg1, topic_id: topicid, answeruser: nil) %>
<% if reserv %>
  <% Answer.destroy_by(userid: idreg1, topic_id: topicid, answeruser: nil) %>
<% else %>
  <!-- Выводим блок первых 3-х мест -->
    <%= render "answers/mesto" %>
  <!-- Выводим таблицу результатов для пользователя -->
    <%= render "answers/tabltotal" %>
<% end %>
<% end %>

<!-- Если в тесте вопросов больше чем ответов -->
<% answer_user = Answer.where(userid: idreg1, topic_id: topicid).count - Answer.where(userid: idreg1, topic_id: topicid, answeruser: nil).count %>

<% if count_questions_topic > answer_user %>

  <!-- Создаем переменную с количеством отложенных вопросов -->
  <% countreserve = @topic.answers.where(userid: idreg1, answeruser: nil).count %>

  <!-- Создаем массив id вопросов -->
  <% id_array_questions = [] %>
  <% @topic.questions.each do |question| %>
    <% id_array_questions.push(question.id) %>
  <% end %>

  <!-- Создаем массив id вопросов, на которые пользователь ответил или пропустил -->
  <% if Answer.find_by(userid: idreg1, topic_id: topicid) %>
    <% id_array_questions_answer = [] %>
    <% Answer.where(userid: idreg1, topic_id: topicid).each do |answer| %>
    <% id_array_questions_answer.push(answer.questionid) %>
    <% end %>
  <% end %>

  <!-- Создаем массив id вопросов, которые пользователь пропустил -->
  <% if Answer.find_by(userid: idreg1, topic_id: topicid, answeruser: nil) %>
    <% id_array_questions_answer_reserv = [] %>
    <% Answer.where(userid: idreg1, topic_id: topicid, answeruser: nil).each do |answer_reserv| %>
    <% id_array_questions_answer_reserv.push(answer_reserv.questionid) %>
    <% end %>
  <% end %>

  <!-- Удаляем из массива вопросы, на которые пользователь отвечал или пропустил -->
  <% if id_array_questions_answer and id_array_questions.size > id_array_questions_answer.size %>
    <% id_array_questions = id_array_questions - id_array_questions_answer %>
  <% end %>

  <!-- Порядок вывода вопросов -->
  <% if @topic.rand == "Вкл." %>
    <% array_size = id_array_questions.size - 1 %>
    <% number_questions = rand(0..array_size) %>
  <% else %>
    <% number_questions = 0 %>
  <% end %>

  <!-- Выводим изображение -->
  <% if Question.find_by(id: id_array_questions[number_questions]).imgquestion.size > 0 %>
    <div><%= image_tag Question.find_by(id: id_array_questions[number_questions]).imgquestion.url(:big), class: "imgquestion" %></div>
  <% end %>

  <!-- Выводим вопросы -->
  <% if Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div><h5><%= Question.find_by(id: id_array_questions[number_questions]).titlequestion %></h5></div>
  <% end %>

  <!-- Создаем рандонное чило -->
  <% numberanswer = rand(0..6) %>

  <span hidden class="hid"><%=id_array_questions[number_questions] %></span>

  <!-- Выводим рандонно ответы-->
  <% answer = Question.find_by(id: id_array_questions[number_questions]) %>
  <% if numberanswer == 0 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 1 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 2 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 3 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 4 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 5 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
    </div>
  <% end %>
  <% if numberanswer == 6 and Question.find_by(id: id_array_questions[number_questions]).titlequestion %>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>A: </strong></span><span class ="answerspan"><%= answer.answer4 %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>B: </strong></span><span class ="answerspan"><%= answer.answer2 %></span></div></div>
    </div>
    <div class="row">
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>C: </strong></span><span class ="answerspan"><%= answer.answertrue %></span></div></div>
      <div class="answ col-6"><div class="spanansw"><span class ="variant"><strong>D: </strong></span><span class ="answerspan"><%= answer.answer3 %></span></div></div>
    </div>
  <% end %>

  <!-- Скрытая форма для передачи ответа и вопроса -->
  <%= form_with(model: [@topic, @topic.answers.build], local: true) do |form| %>
    <span class="answerus">
      <%= form.text_field :answeruser, class: "hid" %>
    </span>
    <%= form.hidden_field :questionid, class: "answer_questionid", value: id_array_questions[number_questions] %>
    <%= form.hidden_field :userid, class: "answer_userid", value: idreg1 %>
    <%= form.hidden_field :usercode, class: "answer_usercode", value: current_username.encrypted_password %>
    <%= form.submit "Ответить", name: "add", class: "but-hid", id: "addbut"%>
  <% end %>

  <!-- Если в задании осталось больше одного вопроса, то выводим кнопку пропустить -->
  <% count = Answer.where(userid: idreg1, topic_id: topicid).count - Answer.where(userid: idreg1, topic_id: topicid, answeruser: nil).count %>
  <% count_questions = count_questions_topic - count %>
  <% if count_questions > 1 %>
    <%= form_with(model: [@topic, @topic.answers.build], local: true) do |form| %>
      <%= form.hidden_field :questionid, class: "answer_questionid", value: id_array_questions[number_questions] %>
      <%= form.hidden_field :userid, class: "answer_userid", value: idreg1 %>
      <%= form.hidden_field :usercode, class: "answer_usercode", value: current_username.encrypted_password %>
      <%= form.submit "Пропустить", name: "add", class: "nextbutton topic_button btn btn-primary" %>
    <% end %>
  <% end %>
<% end %>
